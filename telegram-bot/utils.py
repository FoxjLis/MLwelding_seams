from telegram import Update
import cv2

dict_of_help = {
    'adj': 'Брызги возникают, когда мелкие частицы сварочного шва оседают на поверхности. Как ни старайся, полностью избавиться от брызг невозможно. Однако есть несколько способов свести его к минимуму. Причины разбрызгивания:  \n Высокий сварочный ток \n Слишком низкое напряжение \n Рабочий угол электрода слишком большой\n Плохая зачистка свариваемых поверхностей \n Сварка длинной дугой \n Неправильная полярность \n Способы предупреждения: \n Очистите поверхности перед сваркой \n Уменьшите длину дуги \n Отрегулируйте сварочный ток \n Увеличьте угол электрода \n Соблюдайте полярность \n Способы устранения: \n Зачистить шлифовальным инструментом поверхность сварного соединения от брызг металла.',
    'int': 'Причиной возникновения пор может стать сварка сырыми (непросушенными) электродами или же сварка по грязному металлу (наличие ржавчины, масла, краски). Захваченные газы создают заполненный пузырьками сварной шов, который становится слабым и может со временем разрушиться. \n Причины пористости: \n Недостаточная прокалка электрода перед началом работы \n Сварка длинной дугой \n Плохая газовая защита сварочной ванны \n Неправильная обработка поверхности перед началом работы \n Работа по загрязненной поверхности \n Наличие ржавчины, краски, жира или масла на металле \n Способы предупреждения: \n Перед сваркой очистите поверхность свариваемого металла \n Прокалите электроды \n Проверьте расходомер газа и убедитесь, что он оптимизирован в соответствии с требованиями с соответствующими настройками давления и расхода \n Снизьте скорость движения дуги, чтобы газы улетучились \n Используйте правильную технику сварки \n Способы устранения: \n Дефектный участок вырубают или вычищают и вновь заваривают. \n Включение шлака – один из дефектов сварки, который обычно хорошо заметен в сварном шве. Шлак – это стекловидный материал, образующийся как побочный продукт при сварке электродом, дуговой сварке порошковой проволокой и дуговой сварке под флюсом. Это может произойти, когда флюс, который является твердым защитным материалом, используемым при сварке, плавится в сварном шве или на поверхности зоны сварного шва. \n Самым серьезным видом сварочного дефекта считается трещина сварного шва, которая не принимается почти всеми отраслевыми стандартами. Она может появиться на поверхности, в металле сварного шва или в зоне воздействия сильного тепла. В зависимости от температуры, при которой они возникают, существуют разные типы трещин: \n Горячие трещины. Они появляются в процессе сварки или в процессе кристаллизации сварного соединения. Температура в этот момент может подняться выше 10 000 °C.\n Холодные трещины. Эти трещины появляются после завершения сварки и снижения температуры металла. Они могут образоваться спустя несколько часов или даже дней после проведения сварочных работ. Чаще всего это происходит при сварке стали. Причиной этого дефекта обычно являются деформация структуры стали.\n Кратеры. Обычно они образуются ближе к концу сварного шва. Когда сварочная ванна охлаждается и затвердевает, ей необходимо иметь достаточный объем, чтобы преодолеть усадку металла шва. В противном случае образуется кратерная трещина.\n Причины появления трещин:\n Повышенное содержание углерода и серы в основном металле\n Повышенная жесткость свариваемой конструкции\n Загрязнение основного металла\n Высокая скорость сварки, но низкий ток\n Неправильная форма шва из-за несоблюдения режима сварки\n Резкое охлаждение конструкции\n Способы предупреждения:\n Правильно выбирайте основной металл и сварочные материалы\n Выбирайте оптимальный режим сварки\n Обеспечьте надлежащее охлаждение зоны сварки\n Используйте правильную геометрию швов\n Удалите загрязнения со свариваемого металла\n Используйте подходящий металл\n Убедитесь, что свариваете достаточную площадь сечения\n Используйте правильную скорость сварки и силу тока\n Чтобы предотвратить появление кратерных трещин, убедитесь, что кратер заполнен должным образом\n Способы устранения:\n Место образования трещины удалить шлифовальным инструментом. Образовавшуюся полость заварить.',
    'geo': 'Подрезы \n Этот дефект сварки представляет собой образование бороздок на протяжении всего сварного шва, уменьшающее толщину поперечного сечения основного металла. В результате получается ослабленный сварной шов. \n Причины возникновения подрезов: \n Слишком высокий сварочный ток \n Слишком высокая скорость сварки \n Неудобное пространственное положение, из-за которого к свободным краям будет направлено больше тепла \n Неточное ведение электрода по оси стыка \n Неправильный присадочный металл \n Плохая техника сварки \n Способы предупреждения: \n Ведите электрод под правильным углом \n Проводите сварку короткой дугой \n Выберите оптимальный режим сварки \n Выберите защитный газ, состав которого соответствует типу материала, который вы будете сваривать \n Использование электродов под правильным углом, при этом большее количество тепла направляйте на более толстые компоненты \n Регулируйте силу тока, уменьшая его при приближении к более тонким участкам и свободным краям \n Способы устранения: \n Место подреза зачищают и заваривают шов заново. \n Непровары \n Этот тип сварочного дефекта возникает при отсутствии надлежащего сплавления основного металла и металла шва. Непровар также может появиться между прилегающими сварными швами. Это создает зазор в стыке, который не заполняется расплавленным металлом. \n Причины непровара: \n Недостаточная сила тока \n Плохая зачистка свариваемых поверхностей \n Неправильный угол электрода \n Диаметр электрода не соответствует толщине свариваемого материала \n Высокая скорость сварки \n Способы предупреждения: \n Соблюдайте режимы сварки \n Перед тем как приступить к сварке, зачистите металл \n Ведите сварку короткой дугой \n Способы устранения: \n Если непровар доступен для повторной заварки, то корень шва в месте дефекта вычищают и заваривают повторно.',
    'pro': 'дефекты постобработки',
    'non': 'дефекты невыполнения (незаполнение раковины, несплавление, название класса) \n Несплавление\n Несплавление происходит, когда канавка металла заполнена не полностью, то есть металл сварного шва не заполнил толщину соединения.\n Причины несплавления:\n Между свариваемым металлом было слишком много места\n Вы производите сварку при низких настройках силы тока, которого недостаточно, чтобы должным образом расплавить металл\n Используете электроды большого диаметра\n Способы предупреждения:\n Используйте правильную геометрию шва\n Используйте электрод подходящего размера\n Снизьте скорость дуги\n Выберите подходящий сварочный ток\n Проверьте правильность центровки\n Способы устранения: \n Если несплавление доступно для повторной заварки, то корень шва в месте дефекта вычищают и заваривают повторно.'

}

async def download_photo(update: Update) -> str:
    photo = update.message.photo[-1]
    photo_file = await photo.get_file()
    photo_path = 'photo.jpg'
    await photo_file.download_to_drive(photo_path)
    return photo_path

def process_image(results, image, model, defect_descriptions, confidence_threshold):
    response = "Классификация завершена. Результаты:\n"
    for result in results:
        for box in result.boxes:
            class_id = int(box.cls)
            confidence = float(box.conf)  # Преобразование Tensor к float
            label = model.names[class_id]
            defect_description = defect_descriptions.get(class_id, label)
            response += f'{defect_description}: {confidence:.2f}\n' + '\n' + dict_of_help[label]

            # Рисование ректов на изображении
            x1, y1, x2, y2 = map(int, box.xyxy[0])
            cv2.rectangle(image, (x1, y1), (x2, y2), (0, 255, 0), 2)
            cv2.putText(image, f'{label} {confidence:.2f}', (x1, y1 - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.9, (36, 255, 12), 2)

    return response, image
